% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_ols.R
\name{fit_ols}
\alias{fit_ols}
\title{Fit amplitude and phase using OLS harmonic regression}
\usage{
fit_ols(
  empiricalData,
  boundaryMean,
  periodInSeconds,
  optimizeRange,
  nmin,
  empiricalDataPeriods
)
}
\arguments{
\item{empiricalData}{A zoo object with one column per sensor depth.}

\item{boundaryMean}{Numeric -- mean temperature. Not used by OLS (beta_0 is
estimated freely) but retained for interface compatibility with fitCosine.}

\item{periodInSeconds}{Numeric -- period of the target cycle (s).
86400 for diel, 86400*365.25 for annual.}

\item{optimizeRange}{Numeric length-2 -- valid phase window as fractions of
period relative to boundary sensor. Default c(-0.05, 1.05).}

\item{nmin}{Integer -- minimum non-NA observations to attempt fitting.}

\item{empiricalDataPeriods}{Numeric -- number of complete cycles in the data.}
}
\value{
A list with components:
  \describe{
    \item{deltaPhaseRadians}{Numeric vector of length n^2 -- pairwise phase
      differences (radians). Reshape with derived2DArray().}
    \item{ampRatio}{Numeric vector of length n^2 -- pairwise amplitude ratios.
      Reshape with derived2DArray().}
  }
  Attributes:
  \describe{
    \item{amplitudes}{Named numeric vector -- amplitude per sensor.}
    \item{phases}{Named numeric vector -- phase per sensor (radians).}
  }
}
\description{
Uses the trigonometric identity A*cos(wt + phi) = alpha_s*sin(wt) + alpha_c*cos(wt)
to linearize cosine fitting into a standard lm() call (Luce et al. 2013;
observedAmpPhase.tex Eqs. 1-3). This avoids the convergence issues,
starting-value sensitivity, and noise-injection workarounds required by nls.
}
\details{
The model at each depth is:
  T(t) = beta_0 + alpha_s * sin(omega * t) + alpha_c * cos(omega * t)

where beta_0 captures the mean, and amplitude and phase are recovered via:
  A   = sqrt(alpha_s^2 + alpha_c^2)
  phi = atan2(alpha_s, alpha_c)


**Why OLS over nls:** The linearized form reduces cosine fitting to ordinary
least squares, which has a closed-form solution. No starting values, no
iteration, no convergence failure on perfect cosines. On synthetic round-trip
tests this recovers parameters to machine precision (~1e-15 relative error)
versus ~1e-4 for the nls approach with its required noise injection.

**Phase convention:** atan2(alpha_s, alpha_c) returns the phase in (-pi, pi].
We wrap to [0, 2*pi) for consistency, then unwrap relative to the boundary
sensor phase. This is equivalent to the conditional arctan in
observedAmpPhase.tex Eq. 3 but handles all four quadrants automatically.

**Interface compatibility:** Output structure matches fitCosine() exactly,
so thObservedSeries needs no changes to use this as a drop-in replacement.
}
\references{
Luce, C. H., Tonina, D., Gariglio, F., & Applebee, R. (2013). Solutions for
the diurnally forced advection-diffusion equation to estimate bulk fluid
velocity and diffusivity in streambeds from temperature time series. Water
Resources Research, 49, 488-506. doi:10.1002/wrcr.20090
}
